# Make

## Format

A make file consist of 3 main parameters(rules):

1. Target - the name of the file that needs to be generated by a program (executable or object files)
2. Prerequistites - a file that is used as a input to create the target.
3. Recipe - the action the `make` carries out. This can be more than one command either on the same line or on its own. 

> [!NOTE] 
> The recipe needs a `\t` `tab` at the beginning of each recipe

Example:
```
target: prerequistites ...
	recipe <-- Notice this has a tab
```

When running `make` it will build the very first target listed in the make file by convention. 

```
Makefile
# This is a make file

all: program main

program: program.o
	gcc program -o program

main: main.o
	gcc main.o -o main	

main.o: main.c
	gcc -c main.c

program.o: program.c
	gcc -c program.c

$ make
gcc -c program.c
gcc -c main.c
gcc main.o -o main
gcc program.o -o program

$ ls 
main.o program.o program main
```

But lets just say you just want to make just program, instead of typing `make` do:

```
$ make program
$ ls
program program.o
```

There can be a `.Phony` target which carries out an action that does not produce a file.

### Assignment Operators

- `=` - Verbatim assignment - only expands when invoked using `$(variable)`
- `:=` - Simple expansion - expands the variable immediately
- `!=` - Shell output
- `?=` - Conditional assignment
- `+=` - Append it

Simple Expansion:
```
SRCS = main.c
OBJ := $(SRCS:.c=.o) <---- Expanded as main.c=main.o then sets it to OBJ

# So instead it looks like this
OBJ = main.c=main.o
```

<details>
<summary>Assignment Operator Examples</summary>
```
SRCS = main.c
SRCS := $(wildcard *.c)
SRCS != find . -name "*.c"
SRCS := $(shell find. name "*.c")
CC_FLAGS += -Wextra
CFLAGS ?= $(CC_FLAGS)
FOO := $(BAR) # Comment
```
</details>

### Special Variables

There are seven core automatic variables:

1. `$@`: THe filename representing the target
2. `$%`: The filename element of an archive member specifications
3. `$<`: The file name of the first prerequistite
4. `$?`: The names of all prerequistites that are newer than the target, separated by spaces
5. `$^`: The filenames of all the prerequistites, seperated by spaces. This list has duplicated filenames removed
6. `$+`: The filenames of all the prerequistites, seperated by spaces. This list has duplicates
7. `$*`: The stem of the target filename. A stem is typically a filename without its suffix.

Example:
```
server: main.o server.o net_utility.o
	gcc -o $@ $^ $<
```
- `$@` = server (target)
- `$^` = main.o server.o net_utility.o (all prerequistites)
- `$<` = main.o (first prerequistite)

### Argument Variables

To incorporate command line variables within a make file `$(VARIABLE)` will be add inside of the recipe. The **VARIABLE** will be invoked when running the makefile 

Example:
```
# Makefile
CC=gcc
CFLAGS=-Wall -Wextra

BIN=script
SRC=script.c
OBJ=script.o

run-script: $(BIN)
	./$(BIN) $(VARIABLE)
	
$(SRC):$(OBJ)
	$(CC) $(CFLAGS) -c $@ -o $^
```

```
$ make run-script VARIABLE=command_line_argument
$ ./script command_line_argument

```

A conditional value can be set to using `VARIABLE ?= conditional_variable`, so when running the script above the following output would prefill with the conditional value.
```
$ make run-script
$ ./script conditional_variable
```

Notice that conditional_variable was implicitly set even though no `VARIABLE=` was invoked when running `make run-script`

To run a Makefile in a different dirrectory just do `make -C  /dir` where the `/dir` is the specified directory with its own make file.

```
.
└── dir
    └── Makefile

# Where dir has its own Makefile
make -C /dir
```

### Built in Functions

- `$(SRCS:.c=.o)`
- `$(addprefix build/,$(OBJS))`
- `$(if ..) $(or ..) $(and ..)`
- `$(foreach var, list, text)`
- `$(value (VARIABLE))`
- `$(shell ..)`
- `$(error ..)`
- `$(warning ..)`
- `$(info ..)`

#### Special Commands

- `-` - Ignore errors while executing
- `@` - Don't print to standard output
- `+` - Execute even if Make is in "do not execute" mode

#### Multi Line Commands

Each line of your command is run in a **Seperate** terminal instance

```
target: prerequisites
	cd dir
	ls 
```

The following example above will `cd` into a directory called _dir_ exit the terminal instance and preform `ls`
```
~/random_directory $ make target
cd dir
ls
.
..
random_stuff
```

To make the commands run in the same "terminal instance" add `;\` to preform multiline command
```
target: prerequistites
	cd dir;\
	ls
# This will go into the dir and list out whats in /dir
```



